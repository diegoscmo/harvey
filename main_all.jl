################################################################################
# Lagrangiano Aumentado // Otimização Topológica
################################################################################

# Copiar para o console para executar:
# cd(ENV["HARVEY"]);
# include("main_all.jl"); main_all();

# Carrega rotina de Otimização Topológica e auxiliáres
include("fem\\Rotinas_Fem.jl")
include("opt\\Top_Opt.jl")
include("fobj\\0_Todas_Fobj.jl")

function main()

    # Parâmetros do Lagrangiano Aumentado
    max_ext     = 30        # Máximo de iteracoes externas
    max_int     = 500       # Máximo de iterações internas
    tol_ext     = 1E-6      # Tolerância do laço externo
    tol_int     = 1E-6      # Tolerância do laço interno
    rho         = 1.00      # Valor inicial de rho
    rho_max     = 2.50      # Valor maximo de rho
    mult_max    = 10.0      # Valor maximo dos multiplicadores

    # Parâmetros da topológica
    SP          = 3.00      # Parametro p do SIMP
    raiof       = 0.031     # Tamanho do filtro [m]
    vmin        = 1E-9      # Densidade mínima

    # Parâmetros do problema de FEM, 60x30 = 1800 // 140x70 = 9800
    NX          = 140       # Nr. de elementos em X
    NY          = 70        # Nr. de elementos em Y
    LX          = 1.0       # Comprimento em X
    LY          = 0.5       # Comprimento em Y
    young       = 210E9     # Módulo de Young
    poisson     = 0.0       # Coeficiente de Poisson
    esp         = 1.0       # Espessura do retângulo
    p_dens      = 7860.0    # Densidade

    # Restrições de deslocamento (apoios):
    #        [ ponto_X0 ponto_Y0    ponto_XF    ponto_YF    dir (X=1 Y=2)]
    presos = [  0.0     0.0         0.0         LY          1 ;
                0.0     0.0         0.0         LY          2 ]

    # Carregamentos:
    #        [ ponto_X  ponto_Y     força       dir (X=1 Y=2)]
    forcas = [ LX       LY/2.0      -9000.0     2 ]

          #Num; Caso;   Freq;   Alfa;   Beta;   Ye/Rm;  A;      X0
    dsm = [
            1   1       0.0     0.0     0.0     0.0     0.0     0.49
            2   2       5.0     0.0     1E-8    0.0     0.0     0.49
            3   2       100.0   0.0     1E-8    0.0     0.0     0.49
            4   2       170.0   0.0     1E-8    0.0     0.0     0.49
            5   2       180.0   0.0     1E-8    0.0     0.0     0.49
            6   3       180.0   0.0     1E-8    1.0     0.0     0.49
            7   3       180.0   0.0     1E-8    0.75    0.0     0.49
            8   3       600.0   0.0     1E-8    1.0     0.0     0.49
            9   3       600.0   0.0     1E-8    0.5     0.0     0.49
            10  3       600.0   0.0     1E-8    0.3     0.0     0.49
            11  3       600.0   0.0     1E-8    0.2     0.0     0.49
            12  3       750.0   0.0     1E-8    1.0     0.0     0.49
            13  3       750.0   0.0     1E-8    0.5     0.0     0.49
            14  3       750.0   0.0     1E-8    0.3     0.0     0.49
            15  3       750.0   0.0     1E-8    0.2     0.0     0.49
            16  4       180.0   0.0     1E-8    0.0     0.99    0.49
            17  4       180.0   0.0     1E-8    0.0     0.90    0.49
            18  4       180.0   0.0     1E-8    0.0     0.50    0.49
            19  4       180.0   0.0     1E-8    0.0     0.25    0.49
            20  4       180.0   0.0     1E-8    0.0     0.05    0.49
            21  4       180.0   0.0     1E-8    0.0     0.01    0.49
            22  2       180.0   0.0     1E-2    0.0     0.00    0.49
            23  2       750.0   0.0     1E-2    0.0     0.00    0.49
            24  2       180.0   1000.0  0.0     0.0     0.00    0.49
            25  2       750.0   1000.0  0.0     0.0     0.00    0.49
            26  2       750.0   0.0     1E-3    0.0     0.00    0.49
            27  2       180.0   0.0     1E-8    0.0     0.00    0.49
            28  2       180.0   0.0     1E-4    0.0     0.00    0.49
            29  2       750.0   0.0     1E-8    0.0     0.00    0.49
            30  2       750.0   0.0     1E-4    0.0     0.00    0.49
            31  5       005.0   0.0     1E-8    0.0     0.00    0.49
            32  5       100.0   0.0     1E-8    0.0     0.00    0.49
            33  5       170.0   0.0     1E-8    0.0     0.00    0.49
            34  5       180.0   0.0     1E-8    0.0     0.00    0.49
            35  5       180.0   0.0     666.6   0.0     0.00    0.49
            36  5       600.0   0.0     666.6   0.0     0.00    0.49
            37  5       750.0   0.0     666.0   0.0     0.00    0.49
            38  5       005.0   1.0     0.0     0.0     0.00    0.49
            39  5       100.0   1.0     0.0     0.0     0.00    0.49
            40  5       170.0   1.0     0.0     0.0     0.00    0.49
            41  5       180.0   1.0     0.0     0.0     0.00    0.49
            42  5       180.0   666.6   0.0     0.0     0.00    0.49
            43  5       750.0   666.6   0.0     0.0     0.00    0.49
            44  5       1350.0  666.6   0.0     0.0     0.00    0.49
            45  6       180.0   0.0     666.6   1.0     0.00    0.49
            46  6       180.0   666.6   0.0     1.0     0.00    0.49
            47  6       180.0   0.0     666.6   1.5     0.00    0.49
            48  6       180.0   0.0     666.6   2.0     0.00    0.49
            49  6       180.0   0.0     666.6   5.0     0.00    0.49
            50  6       180.0   0.0     666.6   10.0    0.00    0.49
            51  6       180.0   0.0     666.6   20.0    0.00    0.49
            52  6       180.0   0.0     666.6   0.5     0.00    0.49
            53  6       600.0   0.0     1E-8    1.0     0.00    0.49
            54  6       600.0   0.0     666.6   1.0     0.00    0.49
            55  6       600.0   0.0     666.6   0.3     0.00    0.49
            56  6       600.0   0.0     666.6   0.5     0.00    0.49
            57  6       600.0   0.0     666.6   2.0     0.00    0.49
            58  6       600.0   0.0     666.6   5.0     0.00    0.49
            59  6       600.0   0.0     666.6   10.0    0.00    0.49
            60  6       600.0   0.0     666.6   15.0    0.00    0.49
            61  6       750.0   0.0     666.6   1.0     0.00    0.49
            62  6       750.0   0.0     666.6   0.5     0.00    0.49
            63  6       750.0   0.0     666.6   0.3     0.00    0.49
            64  7       750.0   0.0     666.6   0.0     0.99    0.49
            65  7       750.0   0.0     666.6   0.0     0.95    0.49
            66  7       750.0   0.0     666.6   0.0     0.90    0.49
            67  7       750.0   0.0     666.6   0.0     0.80    0.49
            68  7       750.0   0.0     666.6   0.0     0.70    0.49
            69  7       750.0   0.0     666.6   0.0     0.50    0.49
            70  7       750.0   0.0     666.6   0.0     0.30    0.49
            71  7       750.0   0.0     666.6   0.0     0.10    0.49
            72  6       1450.0  0.0     1E-8    1.0     0.00    0.49
            73  7       1450.0  0.0     666.6   0.0     0.95    0.49
            74  7       1450.0  0.0     666.6   0.0     0.90    0.49
            75  7       1450.0  0.0     666.6   0.0     0.50    0.49
            76  7       1450.0  0.0     666.6   0.0     0.30    0.49
            77  7       1450.0  0.0     666.6   0.0     0.10    0.49
            78  7       180.0   0.0     666.6   0.0     0.999   0.49
            79  7       180.0   0.0     666.6   0.0     0.99    0.49
            80  7       600.0   0.0     666.6   0.0     0.999   0.49
            81  7       600.0   0.0     666.6   0.0     0.99   0.49
            82  8       600.0   0.0     666.6   1.0     0.99    0.49
            83  8       600.0   0.0     666.6   1.0     0.90    0.49
            84  8       600.0   0.0     666.6   1.0     0.50    0.49
            85  8       600.0   0.0     666.6   1.0     0.30    0.49
            86  8       400.0   0.0     666.6   1.0     0.30    0.49
            87  8       180.0   0.0     666.6   1.0     0.99    0.49
            88  8       180.0   0.0     666.6   1.0     0.99    0.20
            89  8       180.0   0.0     666.6   1.0     0.90    0.20
            90  8       1350.0  0.0     666.6   1.0     0.90    0.49
            91  8       1350.0  0.0     666.6   1.0     0.80    0.49
            92  8       1350.0  0.0     666.6   1.0     0.70    0.49
            93  8       1350.0  0.0     666.6   1.0     0.30    0.49
            94  8       250.0   0.0     666.6   1.0     0.70    0.49
            95  8       250.0   0.0     666.6   1.001   -0.70   0.49
            96  8       400.0   0.0     666.6   1.000   -0.70   0.49
            97  8       400.0   0.0     666.6   1.001   -0.70   0.49
            98  8       400.0   0.0     666.6   1.001   -0.50   0.49
            99  8       600.0   0.0     666.6   1.001   -0.70   0.49
            100 8       600.0   0.0     666.6   0.999   -0.70   0.49
            101 8       700.0   0.0     666.6   0.999   -0.50   0.49
            102 8       100.0   0.0     666.6   0.999   -0.90   0.49
            103 8       100.0   0.0     666.6   0.999   -0.80   0.49
            104 8       100.0   0.0     666.6   1.001   -0.80   0.49
            105 8       100.0   0.0     666.6   1.001   -0.20   0.49
]

    #CS = [1,2,3,4,5,6,7,33,45]
    #CS = [52,53,54,55,58,61]
    #CS = [62,65,68,69,70,73]
    CS = [82,83,84,85,86]

    for i in CS         #1:105

        num  = Int(dsm[i,1]);
        caso = Int(dsm[i,2]);
        freq = dsm[i,3];
        alfa = dsm[i,4];
        beta = dsm[i,5];
        Ye   = dsm[i,6];
        A    = dsm[i,7];
        dini = dsm[i,8];

        if alfa == 666.6
            alfa = 0.8*(2.0*pi*freq)
        end
        if beta == 666.6
            beta = 0.1/(2.0*pi*freq)
        end

        # Nome do Arquivo ou data de execução("OFF desliga")
        dts = ""
        nel = (NX+1)*(NY+1)
        if caso == 1
            dts = string(num,"_",caso,"_n",nel)
        elseif caso == 2
            dts = string(num,"_",caso,"_f",freq,"_n",nel)
        elseif caso == 3
            dts = string(num,"_",caso,"_f",freq,"_Y",Ye,"_n",nel)
        elseif caso == 4
            dts = string(num,"_",caso,"_f",freq,"_A",A,"_n",nel)
        elseif caso == 5
            dts = string(num,"_",caso,"_f",freq,"_n",nel)
        elseif caso == 6
            dts = string(num,"_",caso,"_f",freq,"_Y",Ye,"_n",nel)
        elseif caso == 7
            dts = string(num,"_",caso,"_f",freq,"_A",A,"_n",nel)
        elseif caso == 8
            dts = string(num,"_",caso,"_f",freq,"_A",A,"_R",Ye,"_n",nel)
        else
            error("ERRO NO CASO")
        end

        Top_Opt(dts, caso, freq, alfa, beta, Ye, A, dini, max_ext, max_int, tol_ext,
                   tol_int, rho, rho_max, mult_max, SP, raiof, vmin, NX, NY, LX, LY,
                                        young, poisson, esp, p_dens, presos, forcas)

    end
    quit()
end
